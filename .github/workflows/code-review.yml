name: AI Code Review via API

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      # ---------- 1. ì†ŒìŠ¤ & íŒŒì´ì¬ ì„¸íŒ… ----------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jq requests pathlib

      # ---------- 2. Python íŒŒì¼ ìˆ˜ì§‘ + AI-API í˜¸ì¶œ ----------
      - name: Build review payload via Python
        id: py-payload
        env:
          CODE_REVIEW_API_URL: ${{ secrets.CODE_REVIEW_API_URL }}
          OPENAI_MODEL_NAME:   ${{ vars.OPENAI_MODEL_NAME || 'gpt-4o' }}
          PR_BASE_SHA:         ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA:         ${{ github.event.pull_request.head.sha }}
        run: python3 .github/scripts/ai_review.py

      # ---------- 3. ë¦¬ë·° ëŒ€ìƒ ì—†ìŒ ----------
      - name: Handle No Files Case
        if: steps.py-payload.outputs.has_files == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.issue.number,
              body:  `# ðŸ¤– AI Code Review\n\nNo Python or supported files found in this PR to review.`
            });

      # ---------- 4. ìš”ì•½ + ì¸ë¼ì¸ ë¦¬ë·° ----------
      - name: Post AI Code Review Summary and Inline Comments
        if: steps.py-payload.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs   = require('fs');
            const file = './temp_pr_review.json';
            if (!fs.existsSync(file)) {
              console.log('No review response file found');
              return;
            }

            const rawData = fs.readFileSync(file, 'utf8');
            let reviewData;
            try {
              reviewData = JSON.parse(rawData);
            } catch (parseError) {
              console.log('Failed to parse response as JSON, attempting to extract embedded JSON...');
              const jsonMatch = rawData.match(/```json\s*([\s\S]*?)\s*```/);
              if (jsonMatch && jsonMatch[1]) {
                try {
                  const embeddedJson = jsonMatch[1].trim();
                  reviewData = JSON.parse(embeddedJson);
                  console.log('Successfully extracted embedded JSON');
                } catch (embeddedError) {
                  console.log('Failed to parse embedded JSON:', embeddedError.message);
                  reviewData = { summary: rawData, highlights: [], top_priorities: [], growth_suggestions: [] };
                }
              } else {
                console.log('No embedded JSON found, using raw data');
                reviewData = { summary: rawData, highlights: [], top_priorities: [], growth_suggestions: [] };
              }
            }

            let summaryComment = '';
            
            // APIê°€ ë°˜í™˜í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ë¦¬ë·° ë°ì´í„°ë¥¼ ì§ì ‘ ì‚¬ìš©
            if (reviewData.summary && typeof reviewData.summary === 'string') {
              summaryComment = reviewData.summary;
            } else if (reviewData.summary && typeof reviewData.summary === 'object') {
              const summary = reviewData.summary;
              if (summary.positive_feedback && typeof summary.positive_feedback === 'string') {
                summaryComment = summary.positive_feedback;
              } else {
                // ... (ìƒëžµëœ ê¸°ì¡´ JSON ì²˜ë¦¬ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ê±°ë‚˜ summary.positive_feedbackìœ¼ë¡œ ëŒ€ì²´ë¨)
                summaryComment = summary.positive_feedback || 'ë¦¬ë·° ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
              }
            } else {
              summaryComment = '# ðŸ“ AI Code Review\në¦¬ë·°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }

            const comments = reviewData.comments || [];
            console.log(`Inline Comments: ${comments.length}`);

            // Footer ì¶”ê°€
            summaryComment += `\n---\n*Generated by AI Code Review Bot (OpenAI)*`;

            // ì½”ë©˜íŠ¸ ê²Œì‹œ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.issue.number,
              body:  summaryComment
            });

            // ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸
            if (comments.length > 0) {
              console.log(`Posting ${comments.length} inline comments...`);
              for (const c of comments) {
                try {
                  await github.rest.pulls.createReviewComment({
                    owner:        context.repo.owner,
                    repo:         context.repo.repo,
                    pull_number:  context.issue.number,
                    commit_id:    context.payload.pull_request.head.sha,
                    body:         c.body,
                    path:         c.file_path,
                    side:         'RIGHT',
                    line:         c.line_number || 1
                  });
                } catch (error) {
                  console.log(`Failed to post comment on ${c.file_path}:${c.line_number}`, error.message);
                }
              }
            }

      # ---------- 5. ì•„í‹°íŒ©íŠ¸ ì €ìž¥ ----------
      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-results
          path: |
            ./temp_pr_review.json
